# Linux_D02:

----------------------------------------------------------------------------

- [Linux\_D02:](#linux_d02)
    - [1. Инструмент ipcalc:](#1-инструмент-ipcalc)
    - [2. Статическая маршрутизация между двумя машинами:](#2-статическая-маршрутизация-между-двумя-машинами)
    - [3. Утилита iperf3:](#3-утилита-iperf3)
    - [4. Сетевой экран:](#4-сетевой-экран)
    - [5. Статическая маршрутизация сети:](#5-статическая-маршрутизация-сети)
    - [6. Динамическая настройка IP с помощью DHCP:](#6-динамическая-настройка-ip-с-помощью-dhcp)
    - [7. NAT:](#7-nat)
    - [8. Знакомство с SSH Tunnels:](#8-знакомство-с-ssh-tunnels)

----------------------------------------------------------------------------

## 1. Инструмент ipcalc:
- Поднял vm на **Ubuntu 24.04.6 LTS** с *hostname* **ws1**  и выполнил команду `cat /etc/issue`, что бы проверить версию.

> Вывод файла `/etc/issue`:
>
> ![Вывод файла /etc/issue](screen%2Fscreen_1_01.png)
>

- Выполнил команду от имени администратора `sudo` `apt install ipcalc`, что бы скачать утилиту ipcalc.

> Установка **ipcalc**:
>
> ![Установка ipcalc](screen%2Fscreen_1_02.png)
>

**1.1 Сети и маски:**
1) Адрес сети:

- Выполнил команду `ipcalc 192.167.38.54/13`.

> Вывод команды `ipcalc 192.167.38.54/13`:
>
> ![Вывод команды ipcalc 192.167.38.54/13](screen%2Fscreen_1_03.png)
>

- 192.167.38.54/13:
  - Адрес сети: 192.160.0.0

2) Перевод маски:

- Выполнил команду `ipcalc 255.255.255.0`.

> Вывод команды `ipcalc 255.255.255.0`:
>
> ![Вывод команды ipcalc 255.255.255.0](screen%2Fscreen_1_04.png)
>

- 255.255.255.0:
  - Префиксная запись: /24
  - Двоичная запись: 11111111.11111111.11111111.00000000


- Выполнил команду `ipcalc 0.0.0.0/15`.

> Вывод команды `ipcalc 0.0.0.0/15`:
>
> ![Вывод команды ipcalc 0.0.0.0/15](screen%2Fscreen_1_05.png)
>

- /15:
  - Обычная запись: 255.254.0.0
  - Двоичная запись: 11111111.11111110.00000000.00000000


- Маска 11111111.11111111.11111111.11110000 содержит 28 единиц, поэтому префиксная запись выглядит как /28.


- Выполнил команду `ipcalc 0.0.0.0/28`.

> Вывод команды `ipcalc 0.0.0.0/28`:
>
> ![Вывод команды ipcalc 0.0.0.0/28](screen%2Fscreen_1_06.png)
>

- 11111111.11111111.11111111.11110000:
  - Префиксная запись: /28
  - Обычная запись: 255.255.255.240

3) Минимальный и максимальный хост в сети:

- Выполнил команду `ipcalc 12.167.38.4/8`.

> Вывод команды `ipcalc 12.167.38.4/8`:
>
> ![Вывод команды ipcalc 12.167.38.4/8](screen%2Fscreen_1_07.png)
>

- Сеть 12.167.38.4 с маской /8:
  - Минимальный хост: 12.0.0.1
  - Максимальный хост: 12.255.255.254


- Маска 11111111.11111111.00000000.00000000 содержит 16 единиц, поэтому префиксная запись выглядит как /16.


- Выполнил команду `ipcalc 12.167.38.4/16`.

> Вывод команды `ipcalc 12.167.38.4/16`:
>
> ![Вывод команды ipcalc 0.0.0.0/16](screen%2Fscreen_1_08.png)
>

- Сеть 12.167.38.4 с маской /16:
  - Минимальный хост: 12.167.0.1
  - Максимальный хост: 12.167.255.254


- Выполнил команду `ipcalc 12.167.38.4/255.255.254.0`.

> Вывод команды `ipcalc 0.0.0.0/255.255.254.0`:
>
> ![Вывод команды ipcalc 0.0.0.0/255.255.254.0](screen%2Fscreen_1_09.png)
>

- Сеть 12.167.38.4 с маской /255.255.254.0:
  - Минимальный хост: 12.167.38.1
  - Максимальный хост: 12.167.39.254


- Выполнил команду `ipcalc 12.167.38.4/4`.

> Вывод команды `ipcalc 0.0.0.0/4`:
>
> ![Вывод команды ipcalc 0.0.0.0/4](screen%2Fscreen_1_10.png)
>

- Сеть 12.167.38.4 с маской 4:
  - Минимальный хост: 0.0.0.1
  - Максимальный хост: 15.255.255.254

**1.2. localhost:**

*Диапазон адресов 127.0.0.0/8 называется диапазоном адресов внутреннего хоста (Internal host loopback). IPv4-адреса такой формы используются для обращения к самому хосту. Если вы запросите любой из этих адресов на любом сетевом устройстве, вы должны получить ответ.*

**Статья в [Wikipedia](https://en.wikipedia.org/wiki/Localhost)**.

- Выполнил команду `ipcalc 127.0.0.0/8`.

> Вывод команды `ipcalc 127.0.0.0/8`:
>
> ![Вывод команды ipcalc 127.0.0.0/8](screen%2Fscreen_1_11.png)
>

- Диапазон сети 127.0.0.0/8:
  - Минимальный хост: 127.0.0.1
  - Максимальный хост: 127.255.255.254

| Адрес | Диапазон                          | Приложение на localhost  с данным ip                    |
| -------- |-----------------------------------|---------------------------------------------------------|
| 194.34.23.100:    | Адрес не в диапазоне 127.0.0.0/8. | Нельзя обратиться к приложению на localhost с этого IP. |
| 127.0.0.2:     | Адрес из диапазона 127.0.0.0/8.   | Можно обратиться к приложению на localhost с этого IP.  |
| 127.1.0.1:    | Адрес из диапазона 127.0.0.0/8.   | Можно обратиться к приложению на localhost с этого IP.  |
| 128.0.0.1:    | Адрес не в диапазоне 127.0.0.0/8. | Нельзя обратиться к приложению на localhost с этого IP. |

**1.3. Диапазоны и сегменты сетей:**

*Частные внутренние адреса не маршрутизируются в Интернете и на них нельзя отправить трафик из Интернета, они работают только в пределах локальной сети.*

- *К частным "серым" адресам относятся IP-адреса из следующих подсетей:*
  - От 10.0.0.0 до 10.255.255.255 с маской 255.0.0.0 или /8 
    - **10.0.0.0/8**
  - От 172.16.0.0 до 172.31.255.255 с маской 255.240.0.0 или /12 
    - **172.16.0.0/12**
  - 192.168.0.0 до 192.168.255.255 с маской 255.255.0.0 или /16 
    - **192.168.0.0/16**


- Выполнил команду `ipcalc 10.0.0.0/8`, что бы узнать диапазон сети.

> Вывод команды `ipcalc 10.0.0.0/8`:
>
> ![Вывод команды ipcalc 10.0.0.0/8](screen%2Fscreen_1_12.png)
>

- Диапазон сети 10.0.0.0/8:
  - Минимальный хост: 10.0.0.1
  - Максимальный хост: 10.255.255.254

- Выполнил команду `ipcalc 172.16.0.0/12`, что бы узнать диапазон сети.

> Вывод команды `ipcalc 172.16.0.0/12`:
>
> ![Вывод команды ipcalc 172.16.0.0/12](screen%2Fscreen_1_13.png)
>

- Диапазон сети 172.16.0.0/12:
  - Минимальный хост: 172.16.0.1
  - Максимальный хост: 172.31.255.254

- Выполнил команду `ipcalc 192.168.0.0/16`, что бы узнать диапазон сети.

> Вывод команды `ipcalc 192.168.0.0/16`:
>
> ![Вывод команды ipcalc 192.168.0.0/16](screen%2Fscreen_1_14.png)
>

- Диапазон сети 192.168.0.0/16:
  - Минимальный хост: 192.168.0.1
  - Максимальный хост: 192.168.255.254

Адреса **10.0.0.45**, **192.168.4.2**, **172.20.250.4**, **172.16.255.255** и **10.10.10.10** входят в диапазоны проверенных сетей, следовательно, они являются частными адресами.

Адреса **134.43.0.2**, **172.0.2.1**, **192.172.0.1**, **172.68.0.2** и **192.169.168.1** находятся вне этих диапазонов, значит их можно использовать качестве публичных адресов.

- Выполнил команду `ipcalc 10.10.0.0/18`, что бы узнать диапазон сети.

> Вывод команды `ipcalc 10.10.0.0/18`:
>
> ![Вывод команды ipcalc 10.10.0.0/18](screen%2Fscreen_1_15.png)
>

- Диапазон сети 10.10.0.0/18:
  - Минимальный хост: 10.10.0.1
  - Максимальный хост: 10.10.63.254

*Адрес шлюза сети должен входить в диапазон HostMin - HostMax.*
- Возможные адреса шлюза у сети **10.10.0.0/18**:
  - **10.10.0.2**
  - **10.10.10.10**
  - **10.10.1.255**

Адреса **10.0.0.1** и **10.10.100.1** не входят в указанный диапазон, и не могут являться шлюзом этой сети.

----------------------------------------------------------------------------

## 2. Статическая маршрутизация между двумя машинами:
- Поднял вторую vm с *hostname* **ws2**.

> Вывод файла `/etc/issue`:
>
> ![Вывод файла /etc/issue](screen%2Fscreen_2_01.png)
>

- Выполнил команду `ip a`, что бы посмотреть существующие сетевые интерфейсы на **ws1**.

> Вывод команды `ip a` (ws1):
>
> ![Вывод команды ip a ws1](screen%2Fscreen_2_02.png)
>

**2.1. Сетевые интерфейсы:**

- **Интерфейсы на ws1:**

  - lo (Loopback Interface):

| Состояние:    | UP. | 
|---------------|-----------------------------------|
| MTU:          | 65536.   | 
| Адрес (IPv4): | 127.0.0.1/8.   | 
| Адрес (IPv6):       | ::1/128. |

  - - enp0s3 (Ethernet Interface):

| Состояние:    | UP. | 
|---------------|-----------------------------------|
| MTU:          | 1500.   | 
| MAC-адрес:          | 08:00:27:30:2c:1a.   | 
| Адрес (IPv4): | 10.0.2.15/24.   | 
| Адрес (IPv6):       | fe80::a00:27ff:fe30:2c1a/64. |

- Выполнил команду `ip a` на **ws2**.

> Вывод команды `ip a` (ws2):
>
> ![Вывод команды ip a ws2](screen%2Fscreen_2_03.png)
>

- **Интерфейсы на ws2:**

  - lo (Loopback Interface):

|  Состояние:             | UP.                          | 
|---------------|-----------------------------------|
| MTU:  | 65536. | 
| Адрес (IPv4): | 127.0.0.1/8.   | 
| Адрес (IPv6): | ::1/128.   |

  - - enp0s3 (Ethernet Interface):

| Состояние:    | UP. | 
|---------------|-----------------------------------|
| MTU:          | 1500.   | 
| MAC-адрес:          | 08:00:27:58:27:34.   | 
| Адрес (IPv4): | 10.0.2.15/24.   | 
| Адрес (IPv6):       | fe80::a00:27ff:fe58:2734/64. |

*Что бы добавить ещё один интерфейс, соответсвующий внутренней сети, нужно изменить настройки в **Virtual Box**.*

- Открыл интерфейс **Virtual Box**.
- Зашел в настройки сети машины **ws1**, и добавил еще один интерфейс с типом подключения **внутренняя сеть**.

> Добавление нового интерфейса в VB **ws1**:
>
> ![Добавление нового интерфейса в VB ws1(1)](screen%2Fscreen_2_04.png)
> ![Добавление нового интерфейса VB ws1(2)](screen%2Fscreen_2_05.png)
> ![Добавление нового интерфейса VB ws1(3)](screen%2Fscreen_2_06.png)
>

- То же самое сделал для второй машины **ws2**.

> Добавление нового интерфейса в VB **ws2**:
>
> ![Добавление нового интерфейса в VB ws2](screen%2Fscreen_2_07.png)
>

- Выполнил команду `ip a` на ws1, что бы убедиться, что интерфейс добавился.

> Вывод команды `ip a` (ws1):
>
> ![Вывод команды ip a ws1](screen%2Fscreen_2_08.png)
>
- **Интерфейс, соответсвующий внутренней сети:**
  - enp0s8 (intnet Interface):

| Состояние:    | UP.                | 
|---------------|--------------------|
| MTU:          | 1500.              | 
| MAC-адрес:          | 08:00:27:c0:3b:6e. |

- Выполнил команду `ip a` на ws2.

> Вывод команды `ip a` (ws2):
>
> ![Вывод команды ip a ws2](screen%2Fscreen_2_09.png)
>

- **Интерфейс, соответсвующий внутренней сети:**
  - enp0s8 (intnet Interface):

| Состояние:    | UP.                | 
|---------------|--------------------|
| MTU:          | 1500.              | 
| MAC-адрес:          | 08:00:27:6c:8c:41. |

**Настраиваем сетевые интерфейсы, с заданными адресами и масками:**

- Изменил файл конфигурации *netplan* на **ws1**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (ws1):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml (ws1)](screen%2Fscreen_2_10.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [192.168.100.10/16] # Статический IP-адрес для интерфейса enp0s8 с маской сети /16 (255.255.0.0).
  version: 2 # Версия схемы Netplan
```

- Изменил файл конфигурации *netplan* на **ws2**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (ws2):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml (ws2)](screen%2Fscreen_2_11.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [172.24.116.8/12] # Статический IP-адрес для интерфейса enp0s8 с маской сети /12 (255.240.0.0).
  version: 2 # Версия схемы Netplan
```

- Выполнил команду от имени администратора `sudo` `netplan apply`, что бы применить настройки на двух машинах.

> Применение настроек сети (ws1):
>
> ![Применение настроек сети (ws1)](screen%2Fscreen_2_12.png)
>

> Применение настроек сети (ws2):
>
> ![Применение настроек сети (ws2)](screen%2Fscreen_2_13.png)
>

**2.1. Добавление статического маршрута вручную:**
- Выполнил команду от имени администратора `sudo` `ip route add 172.24.116.8 dev enp0s3` на ws1.

> Добавляем статический маршрут от ws1 до ws2:
>
> ![Добавляем статический маршрут от ws1 до ws2](screen%2Fscreen_2_14.png)
>

- Выполнил команду от имени администратора `sudo` `ip route add 192.168.100.10 dev enp0s3` на ws2.

> Добавляем статический маршрут от ws2 до ws1:
>
> ![Добавляем статический маршрут от ws2 до ws1](screen%2Fscreen_2_15.png)
>

- Пропинговал **ws2** с **ws1**, командой `ping -c 3 172.24.116.8`, указав отправку 3 пакетов.

> Успешно пропингованный ip 172.24.116.8:
>
> ![Успешно пропингованный ip 172.24.116.8](screen%2Fscreen_2_16.png)
>

- Пропинговал **ws1** с **ws2**, командой `ping -c 3 192.168.100.10`, указав отправку 3 пакетов.

> Успешно пропингованный ip 192.168.100.10:
>
> ![Успешно пропингованный ip 192.168.100.10](screen%2Fscreen_2_17.png)
>

**2.1. Добавление статического маршрута с сохранением:**

- Перезапустил обе машины командой от имени администратора `sudo` `reboot`.
- Изменил файл конфигурации *netplan* на **ws1**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (ws1):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml (ws1)](screen%2Fscreen_2_18.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [192.168.100.10/16] # Статический IP-адрес для интерфейса enp0s8 с маской сети /16 (255.255.0.0).
      routes: # Раздел для статических маршрутов
        - to: 172.24.116.8 # IP-адрес назначения для маршрута
          via: 192.168.100.10   # IP-адрес шлюза для маршрута (в данном случае это тот же IP, что и адрес интерфейса)
  version: 2 # Версия схемы Netplan
```

- Изменил файл конфигурации *netplan* на **ws2**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (ws2):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml (ws2)](screen%2Fscreen_2_19.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP)
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [172.24.116.8/12] # Статический IP-адрес для интерфейса enp0s3 с маской сети /12 (255.240.0.0).
      routes: # Настройка маршрута по умолчанию (default route).
        - to: 192.168.100.10 # Раздел для статических маршрутов
          via: 172.24.116.8 # IP-адрес шлюза для маршрута (в данном случае это тот же IP, что и адрес интерфейса)
  version: 2 # Версия схемы Netplan
```

- Выполнил команду от имени администратора `sudo` `netplan apply`, что бы применить настройки на двух машинах.

- Пропинговал **ws2** с **ws1**, командой `ping -c 3 172.24.116.8`, указав отправку 4 пакетов.

> Успешно пропингованный ip 172.24.116.8:
>
> ![Успешно пропингованный ip 172.24.116.8](screen%2Fscreen_2_20.png)
>

- Пропинговал **ws1** с **ws2**, командой `ping -c 3 192.168.100.10`, указав отправку 4 пакетов.

> Успешно пропингованный ip 192.168.100.10:
>
> ![Успешно пропингованный ip 192.168.100.10](screen%2Fscreen_2_21.png)
>

----------------------------------------------------------------------------

## 3. Утилита iperf3:
<details><summary>Перевод единиц измерения:</summary>

- **8 Mbps в MB/s**:
  - 1 Mbps = 0.125 MB/s
  - Следовательно, 8 Mbps = 8 * 0.125 = **1 MB/s**.


- **100 MB/s в Kbps**:
  - 1 MB/s = 8 Mbps
  - 1 Mbps = 1000 Kbps
  - Следовательно, 100 MB/s = 100 * 8 * 1000 = **800,000 Kbps**.


- **1 Gbps в Mbps**:
  - 1 Gbps = **1000 Mbps**.
</details>

- Выполнил команду от имени администратора `sudo` `apt install ipef3`, что бы установить утилиту *ipef3*, на двух машинах.

> Установка утилиты **ipef3**:
>
> ![Установка утилиты ipef3](screen%2Fscreen_3_01.png)
>

- Выполнил команду `iperf3 -s` на ws1, что бы настроить её как сервер.

> Вывод команды `iperf3 -s` (ws1):
>
> ![Вывод команды iperf3 -s ws1](screen%2Fscreen_3_02.png)
>

- Выполнил команду `iperf3 -c 192.168.100.10` на ws2, что бы настроить её как клиент и измерить скорость соединения между машинами.

> Вывод команды `iperf3 -c 192.168.100.10` (ws2):
>
> ![Вывод команды iperf3 -c 192.168.100.10 ws2](screen%2Fscreen_3_03.png)
>
> *Средняя скорость соединения между машинами: **2.13 - 2.14 Gbits/sec**.*
>

----------------------------------------------------------------------------

## 4. Сетевой экран:
- Создал файл `/etc/firewall.sh`, имитирующий фаервол, на ws1 и ws2 и настроил удаление всех правил в таблице «filter» (по-умолчанию).

> Настроенный на удаление всех правил в таблице «filter» файл `/etc/firewall.sh` (ws1) (ws2):
>
> ![Настроенный на удаление всех правил в таблице «filter» файл /etc/firewall.sh ws1 ws2](screen%2Fscreen_4_01.png)
>

- Добавил в файлы `/etc/firewall.sh` на **ws1** и **ws2** новые правила, в соответствии с заданием.
  

> Настроенный, в соответствии с заданием, файл `/etc/firewall.sh` (ws1):
>
> ![Настроенный на удаление всех правил в таблице «filter» файл /etc/firewall.sh ws1](screen%2Fscreen_4_02.png)
>

```bash
#!/bin/sh

# удаление всех правил в таблице «filter» (по умолчанию).
iptables -F  # очистка всех правил в таблице "filter".
iptables -X  # удаление всех нестандартных цепочек в таблице "filter".

# разрешение доступа для порта 22 (SSH) и порта 80 (HTTP).
iptables -t filter -A INPUT -p tcp --dport 22 -j ACCEPT  # разрешение входящих подключений на порт 22 (SSH).
iptables -t filter -A INPUT -p tcp --dport 80 -j ACCEPT  # разрешение входящих подключений на порт 80 (HTTP).

# запрет echo reply (машина не должна «пинговаться»).
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j DROP  # запрещает отправку ICMP echo-reply пакетов.

# разрешение echo reply (машина должна «пинговаться»).
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT  # разрешение отправки ICMP echo-reply пакетов, что отменяет предыдущее правило.

```

> Настроенный, в соответствии с заданием, файл `/etc/firewall.sh` (ws2):
>
> ![Настроенный на удаление всех правил в таблице «filter» файл /etc/firewall.sh ws2](screen%2Fscreen_4_03.png)
>

```bash
#!/bin/sh

# удаление всех правил в таблице «filter» (по умолчанию).
iptables -F  # очистка всех правил в таблице "filter".
iptables -X  # удаление всех нестандартных цепочек в таблице "filter".

# разрешение доступа для порта 22 (SSH) и порта 80 (HTTP).
iptables -t filter -A INPUT -p tcp --dport 22 -j ACCEPT  # разрешение входящих подключений на порт 22 (SSH).
iptables -t filter -A INPUT -p tcp --dport 80 -j ACCEPT  # разрешение входящих подключений на порт 80 (HTTP).

# разрешение echo reply (машина должна «пинговаться»).
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT  # разрешение отправки ICMP echo-reply пакетов.

# запрет echo reply (машина не должна «пинговаться»).
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j DROP  # запрещает отправку ICMP echo-reply пакетов, что отменяет предыдущее правило.
```

- Разрешил доступ и запустил файлы на обеих машинах командами от имени администратора `sudo` `chmod +x /etc/firewall.sh` и `sudo` `/etc/firewall.sh`.

> Применение команд `sudo` `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` (ws1):
>
> ![Применение команд chmod +x /etc/firewall.sh и /etc/firewall.sh ws1](screen%2Fscreen_4_04.png)
>

> Применение команд `sudo` `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` (ws2):
>
> ![Применение команд chmod +x /etc/firewall.sh и /etc/firewall.sh ws2](screen%2Fscreen_4_05.png)
>

*Разница между примененными стратегиями состоит в порядке применения правил **ACCEPT** / **DROP** на соответствующих машинах, и, что важнее, в особенности работы **iptables**: к пакетам, удовлетворяющим нескольким заданным стратегиям, применяется правило с наименьшим номером в списке. Это приводит к тому, что **ws1** не отвечает на пинг, тогда как **ws2** возвращает ответ.*

- Выполнил команду от имени администратора `sudo` `iptables -L --line-number` на **ws1**.

*Команда `sudo` `iptables -L --line-number` используется для отображения текущих правил iptables.*
- Разбор команды:
  - Флаг `-L`: сокращение от `--list`, используется для отображения текущих правил в выбранной таблице (по умолчанию, таблица **filter**).
  - Флаг `--line-number`: добавляет номера строк к списку правил. Это позволяет легко ссылаться на конкретное правило при его удалении или изменении.
  

- Пропинговал **ws2** с **ws1**, командой `ping -c 3 172.24.116.8`, указав отправку 3 пакетов.

> Вывод команды `sudo iptables -L --line-number` (ws1):
>
> ![Успешно пропингованный ip 172.24.116.8](screen%2Fscreen_4_06.png)
> 
> Успешно пропингованный **ws1** ip 172.24.116.8
> 

- Выполнил команду от имени администратора `sudo` `iptables -L --line-number` на ws2.
- Пропинговал **ws1** с **ws2**, командой `ping -c 3 192.168.100.10`, указав отправку 3 пакетов.

> Вывод команды `sudo iptables -L --line-number` (ws2):
>
> ![Пинг без ответа ip 192.168.100.10](screen%2Fscreen_4_07.png)
> 
> Пинг **ws1** без ответа ip 192.168.100.10:
>

- Выполнил команду от имени администратора `sudo` `apt install nmap` на двух машинах, что бы установить утилиту nmap.

> Установка утилиты **nmap**:
>
> ![Установка утилиты nmap](screen%2Fscreen_4_08.png)
>

- Выполнил команду `nmap 192.168.100.10` на ws2, что бы убедиться, что машина ws1 запущена.

> В выводе nmap 192.168.100.10 сказано: Host is up
>
> ![Вывод nmap](screen%2Fscreen_4_09.png)
>

*Что бы сохранить дампы образов виртуальных машин, нужно зайти в **Virtual Box**.*

- Открыл интерфейс **Virtual Box**.
- Зашел во вкладку *снимки* машины **ws1**, и сохранил дамп образа виртуальной машины.

> Сохранение дампа образа виртуальной машины в VB ws1:
>
> ![Сохранение дампа образа виртуальной машины в VB ws1(1)](screen%2Fscreen_4_10.png)
> ![Сохранение дампа образа виртуальной машины в VB ws1:(2)](screen%2Fscreen_4_11.png)
> ![Сохранение дампа образа виртуальной машины в VB ws1(3)](screen%2Fscreen_4_12.png)
> ![Сохранение дампа образа виртуальной машины в VB ws1(4)](screen%2Fscreen_4_13.png)
>

- То же самое сделал для второй машины **ws2**.

> Сохранение дампа образа виртуальной машины в VB **ws2**:
>
> ![Сохранение дампа образа виртуальной машины в VB ws2](screen%2Fscreen_4_14.png)
>

----------------------------------------------------------------------------

## 5. Статическая маршрутизация сети:
**Соединение статической маршрутизацией сеть из 5 машин:**

- Поднял пять виртуальных машин (3 рабочие станции (**ws11**, **ws21**, **ws22**) и 2 роутера (**r1**, **r2**)), используя те же образы (ISO) Ubuntu 24.04.6 LTS.

> Т/З по маршрутизации:
>
> ![Т/З по маршрутизации](screen%2Fscreen_5_01.png)
>
> *Как показано на схеме, виртуальные машины **ws11**, **ws21**, **ws22** должны иметь по одному интерфейсу для внутренней сети, а **r1** и **r2** — по два интерфейса.*
>

- Добавил дополнительные интерфейсы для виртуальных машин в настройках **Virtual Box**, по аналогии с [заданием 2](#2-статическая-маршрутизация-между-двумя-машинами).

> Добавление нового интерфейса в VB **ws11**:
>
> ![Добавление нового интерфейса в VB ws11](screen%2Fscreen_5_02.png)
>
> Имя внутренней сети указал `intnet1`, которая будет соответствовать 10.10.0.0/18
>

> Добавление нового интерфейса в VB **ws21**:
>
> ![Добавление нового интерфейса в VB ws21](screen%2Fscreen_5_03.png)
>
> Имя внутренней сети указал `intnet3`, которая будет соответствовать 10.20.0.0/26
>

> Добавление нового интерфейса в VB **ws22**:
>
> ![Добавление нового интерфейса в VB ws22](screen%2Fscreen_5_04.png)
>
> Имя внутренней сети указал `intnet3`, которая будет соответствовать 10.20.0.0/26
>

> Добавление двух новых интерфейсов в VB **r1**:
>
> ![Добавление нового интерфейса в VB r1(1)](screen%2Fscreen_5_05.png)
> 
> Имя внутренней сети указал `intnet1`, которая будет соответствовать 10.10.0.0/18
>
> ![Добавление нового интерфейса VB r1(2)](screen%2Fscreen_5_06.png)
>
> Имя внутренней сети указал `intnet2`, которая будет соответствовать 10.100.0.0/16
>

> Добавление двух новых интерфейсов в VB **r2**:
>
> ![Добавление нового интерфейса в VB r2(1)](screen%2Fscreen_5_07.png)
> 
> Имя внутренней сети указал `intnet2`, которая будет соответствовать 10.100.0.0/16
>
> ![Добавление нового интерфейса VB r2(2)](screen%2Fscreen_5_08.png)
>
> Имя внутренней сети указал `intnet3`, которая будет соответствовать 10.20.0.0/26
>

**5.1. Настройка адресов машин:**
- Изменил файл конфигурации *netplan* на **ws11**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (ws11):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml ws11](screen%2Fscreen_5_09.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.10.0.2/18] # Статический IP-адрес для интерфейса enp0s8 с маской сети /18 (255.255.192.0).
  version: 2 # Версия схемы Netplan
```

- Подтвердил настройки и перезапустил сеть командой от имени администратора `sudo` `netplan apply`.

> Применение настроек конфигураций **netplan** на ws11:
>
> ![Применение настроек конфигураций **netplan** на ws11](screen%2Fscreen_5_10.png)
>

- Изменил файл конфигурации *netplan* на **ws21**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (ws21):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml ws21](screen%2Fscreen_5_11.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.20.0.10/26] # Статический IP-адрес для интерфейса enp0s8 с маской сети /26 (255.255.255.192).
  version: 2 # Версия схемы Netplan
```

- Подтвердил настройки и перезапустил сеть командой от имени администратора `sudo` `netplan apply`.

> Применение настроек конфигураций **netplan** на ws21:
>
> ![Применение настроек конфигураций **netplan** на ws21](screen%2Fscreen_5_12.png)
>

- Изменил файл конфигурации *netplan* на **ws22**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (ws22):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml ws22](screen%2Fscreen_5_13.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.20.0.20/26] # Статический IP-адрес для интерфейса enp0s8 с маской сети /26 (255.255.255.192).
  version: 2 # Версия схемы Netplan
```

- Подтвердил настройки и перезапустил сеть командой от имени администратора `sudo` `netplan apply`.

> Применение настроек конфигураций **netplan** на ws22:
>
> ![Применение настроек конфигураций **netplan** на ws22](screen%2Fscreen_5_14.png)
>

- Изменил файл конфигурации *netplan* на **r1**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (r1):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml r1](screen%2Fscreen_5_15.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.10.0.1/18] # Статический IP-адрес для интерфейса enp0s8 с маской сети /18 (255.255.192.0).
    enp0s9: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.100.0.11/16] # Статический IP-адрес для интерфейса enp0s9 с маской сети /16 (255.255.0.0).
  version: 2 # Версия схемы Netplan
```

- Подтвердил настройки и перезапустил сеть командой от имени администратора `sudo` `netplan apply`.

> Применение настроек конфигураций **netplan** на r1:
>
> ![Применение настроек конфигураций **netplan** на r1](screen%2Fscreen_5_16.png)
>

- Изменил файл конфигурации *netplan* на **r2**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (r2):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml r2](screen%2Fscreen_5_17.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.100.0.12/16] # Статический IP-адрес для интерфейса enp0s8 с маской сети /16 (255.255.0.0).
    enp0s9: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.20.0.1/26] # Статический IP-адрес для интерфейса enp0s9 с маской сети /26 (255.255.255.192).
  version: 2 # Версия схемы Netplan
```

- Подтвердил настройки и перезапустил сеть командой от имени администратора `sudo` `netplan apply`.

> Применение настроек конфигураций **netplan** на r2:
>
> ![Применение настроек конфигураций **netplan** на r2](screen%2Fscreen_5_18.png)
>

- Командой `ip -4 a` на **ws11** проверил, что адрес машины задан верно.

*Флаг `-4`: выводит информацию только о сетевых интерфейсах с IPv4 адресами.*

> Вывод команды `ip -4 a` (ws11):
>
> ![Вывод команды ip -4 a ws11](screen%2Fscreen_5_19.png)
>
> Адрес интерфейса **enp0s8**, задан верно: **10.10.0.2/18**.
>

- Выполнил команду `ip -4 a` на **ws21**.

> Вывод команды `ip -4 a` (ws21):
>
> ![Вывод команды ip -4 a ws21](screen%2Fscreen_5_20.png)
>
> Адрес интерфейса **enp0s8**, задан верно: **10.20.0.10/26**.
>

- Выполнил команду `ip -4 a` на **ws22**.

> Вывод команды `ip -4 a` (ws22):
>
> ![Вывод команды ip -4 a ws22](screen%2Fscreen_5_21.png)
>
> Адрес интерфейса **enp0s8**, задан верно: **10.20.0.20/26**.
>

- Выполнил команду `ip -4 a` на **r1**.

> Вывод команды `ip -4 a` (r1):
>
> ![Вывод команды ip -4 a r1](screen%2Fscreen_5_22.png)
>
> Адреса интерфейсов **enp0s8** и **enp0s9**, заданы верно: **10.10.0.1/18**, **10.100.0.11/16**.
>

- Выполнил команду `ip -4 a` на **r2**.

> Вывод команды `ip -4` a (r2):
>
> ![Вывод команды ip -4 a r2](screen%2Fscreen_5_23.png)
>
> Адреса интерфейсов **enp0s8** и **enp0s9**, заданы верно: **10.100.0.12/16**, **10.20.0.1/26**.
>

- Пропинговал **ws22** с **ws21**, командой `ping -c 4 10.20.0.20`, указав отправку 4 пакетов.

> Успешно пропингованный ip 10.20.0.20:
>
> ![Успешно пропингованный ip 10.20.0.20](screen%2Fscreen_5_24.png)
>

- Пропинговал **r1** с **ws11**, командой `ping -c 4 10.10.0.1`, указав отправку 4 пакетов.

> Успешно пропингованный ip 10.10.0.1:
>
> ![Успешно пропингованный ip 10.20.0.20](screen%2Fscreen_5_25.png)
>

**5.2. Включение переадресации IP-адресов:**
- Выполнил команду от имени администратора `sudo` `sysctl -w net.ipv4.ip_forward=1` на роутерах **r1**, **r2**, что бы включить временную переадресацию IP (до перезапуска системы).

> Вывод команды `sudo sysctl -w net.ipv4.ip_forward=1` (r1):
>
> ![Вывод команды sudo sysctl -w net.ipv4.ip_forward=1 r1](screen%2Fscreen_5_26.png)
>

> Вывод команды `sudo sysctl -w net.ipv4.ip_forward=1` (r2):
>
> ![Вывод команды sudo sysctl -w net.ipv4.ip_forward=1 r2](screen%2Fscreen_5_27.png)
>

- Открыл файлы /etc/sysctl.conf на двух машинах и добавил в них строку `net.ipv4.ip_forward = 1`, что бы IP-переадресация была включена на постоянной основе.

> Измененный файл `/etc/sysctl.conf` (r1):
>
> ![Измененный файл /etc/sysctl.conf r1](screen%2Fscreen_5_28.png)
>

> Измененный файл `/etc/sysctl.conf` (r2):
>
> ![Измененный файл /etc/sysctl.conf r2](screen%2Fscreen_5_29.png)
>

**5.3. Установка маршрута по-умолчанию:**
- Изменил файлы конфигурации etc/netplan/00-installer-config.yaml на **ws11**, **ws21**, **ws22**:

> Измененный файл `etc/netplan/00-installer-config.yaml` (ws11):
>
> ![Измененный файл etc/netplan/00-installer-config.yaml ws11](screen%2Fscreen_5_30.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.10.0.2/18] # Статический IP-адрес для интерфейса enp0s8 с маской сети /18 (255.255.192.0).
      routes: # Раздел, определяющий маршруты
        - to: default # Маршрут по умолчанию (используется, если ни один другой маршрут не подходит)
          via: 10.10.0.1 # Шлюз (роутер), через который проходят все пакеты по умолчанию
  version: 2 # Версия схемы Netplan
```

> Измененный файл `etc/netplan/00-installer-config.yaml` (ws21):
>
> ![Измененный файл etc/netplan/00-installer-config.yaml ws21](screen%2Fscreen_5_31.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
  enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
    dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.20.0.10/26] # Статический IP-адрес для интерфейса enp0s8 с маской сети /26 (255.255.255.192).
      routes: # Раздел, определяющий маршруты
        - to: default # Маршрут по умолчанию (используется, если ни один другой маршрут не подходит)
          via: 10.20.0.1 # Шлюз (роутер), через который проходят все пакеты по умолчанию
  version: 2 # Версия схемы Netplan
```

> Измененный файл `etc/netplan/00-installer-config.yaml` (ws22):
>
> ![Измененный файл etc/netplan/00-installer-config.yaml ws22](screen%2Fscreen_5_32.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
  enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
    dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.20.0.20/26] # Статический IP-адрес для интерфейса enp0s8 с маской сети /26 (255.255.255.192).
      routes: # Раздел, определяющий маршруты
        - to: default # Маршрут по умолчанию (используется, если ни один другой маршрут не подходит)
          via: 10.20.0.1 # Шлюз (роутер), через который проходят все пакеты по умолчанию
  version: 2 # Версия схемы Netplan
```

- Подтвердил настройки и перезапустил сеть командой от имени администратора `sudo` `netplan apply` на машинах **ws11**, **ws21**, **ws22**.


- Выполнил команду `ip r` на **ws11**, **ws21**, **ws22**, что бы проверить добавился ли маршрут в таблицу маршрутизации.

> Вывод команды `ip r` (ws11):
>
> ![Вывод команды ip r ws11](screen%2Fscreen_5_33.png)
> 
> Маршрут интерфейса enp0s8 по-умолчанию установился по-заданному ip 10.10.0.1
> 

> Вывод команды `ip r` (ws21):
>
> ![Вывод команды ip r ws21](screen%2Fscreen_5_34.png)
> 
> Маршрут интерфейса enp0s8 по-умолчанию установился по-заданному ip 10.20.0.1
> 

> Вывод команды `ip r` (ws22):
>
> ![Вывод команды ip r ws22](screen%2Fscreen_5_35.png)
> 
> Маршрут интерфейса enp0s8 по-умолчанию установился по-заданному ip 10.20.0.1
>

- Выполнил команду `ping 10.100.0.12` на **ws11**.

> Вывод команды `ping 10.100.0.12` (ws11):
>
> ![Вывод команды ping 10.100.0.12 ws21](screen%2Fscreen_5_36.png)
>

- Выполнил команду от имени администратора `sudo` `tcpdump -tn -i enp0s8` на **r2**.

> Вывод команды `sudo tcpdump -tn -i enp0s8` (r2):
>
> ![Вывод команды sudo tcpdump -tn -i enp0s8 r2](screen%2Fscreen_5_37.png)
> 
> *Сообщение, которое мы видим в выводе команды **tcpdump** на роутере **r2**, означает, что ICMP запросы (пинг) от машины **ws11** доходят до **r2**.*
> 
> *`10.10.0.2 > 10.100.0.12: ICMP echo request`: Это строка показывает, что пакет ICMP (пинг) отправляется от IP-адреса 10.10.0.2 (ws11) к IP-адресу 10.100.0.12 (r2).*
> 
> *`id 6, seq 40, length 46`: Эти параметры указывают на идентификатор ICMP запроса, номер последовательности и длину пакета соответственно.*
> 
> **Однако ответы ICMP (echo reply) не доходят обратно до ws11.**
>

**5.4. Добавление статических маршрутов:**

- Изменил файл конфигурации *netplan* на роутере **r1**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (r1):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml r1](screen%2Fscreen_5_38.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.10.0.1/18] # Статический IP-адрес для интерфейса enp0s8 с маской сети /18 (255.255.192.0).
    enp0s9:  # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.100.0.11/16] # Статический IP-адрес для интерфейса enp0s9 с маской сети /16 (255.255.0.0).
      routes: # Раздел, определяющий маршруты
        - to: 10.20.0.0/26 # Сетевой маршрут к сети 10.20.0.0 с маской сети /26 (255.255.255.192).
          via: 10.100.0.12 # Шлюз (роутер), через который проходят пакеты к сети 10.20.0.0/26
  version: 2 # Версия схемы Netplan
```

- Подтвердил настройки и перезапустил сеть командой от имени администратора `sudo` `netplan apply`.

- Изменил файл конфигурации *netplan* на роутере **r2**.

> Измененный файл конфигурации `/etc/netplan/00-installer-config.yaml` (r2):
>
> ![Измененный файл конфигурации /etc/netplan/00-installer-config.yaml r2](screen%2Fscreen_5_39.png)
>

```yaml
network: # Основной раздел, который описывает конфигурацию сети
  ethernets: # Раздел, в котором перечислены сетевые интерфейсы
    enp0s3: # Интерфейс с типом подключения NAT (используется для доступа в интернет)
      dhcp4: true # Включение DHCP для данного интерфейса (динамическая настройка IP).
    enp0s8: # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.100.0.12/16] # Статический IP-адрес для интерфейса enp0s8 с маской сети /16 (255.255.0.0).
      routes: # Раздел, определяющий маршруты
        - to: 10.10.0.0/18 # Сетевой маршрут к сети 10.10.0.0 с маской сети /18 (255.255.192.0).
          via: 10.100.0.11 # Шлюз (роутер), через который проходят пакеты к сети 10.10.0.0/18
    enp0s9:  # Интерфейс с типом подключения внутренняя сеть (используется для локальной сети)
      dhcp4: false # Отключение DHCP для данного интерфейса (статическая настройка IP).
      addresses: [10.20.0.1/26] # Статический IP-адрес для интерфейса enp0s9 с маской сети /26 (255.255.255.192).
  version: 2 # Версия схемы Netplan
```

- Подтвердил настройки и перезапустил сеть командой от имени администратора `sudo` `netplan apply`.

- Выполнил команду `ip r` на **r1**.

> Вывод команды `ip r` (r1):
>
> ![Вывод команды ip r r1](screen%2Fscreen_5_40.png)
> 
> Сетевой статический маршрут к сети `10.20.0.0/26` установился по-заданному шлюзу `10.100.0.12`
>

- Выполнил команду `ip r` на **r2**.

> Вывод команды `ip r` (r2):
>
> ![Вывод команды ip r r2](screen%2Fscreen_5_41.png)
> 
> Сетевой статический маршрут к сети `10.10.0.0/18` установился по-заданному шлюзу `10.100.0.11`
>

- Выполнил команду `ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0` на **ws11**.

> Вывод команд `ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0` (ws11):
>
> ![Вывод команд ip r list 10.10.0.0/18 и ip r list 0.0.0.0/0 ws11](screen%2Fscreen_5_42.png)
> 
> Для адреса 10.10.0.0/18 маршрут, отличается от 0.0.0.0/0, потому что адресация, попадающая в диапазон 10.10.0.0/18, должна быть отправлена через интерфейс enp0s8, по заданными настройкам netplan.
> 
> Весь остальной трафик направляется через шлюз 10.10.0.1 по маршруту по умолчанию.
>

**5.5. Построение списка маршрутизаторов:**
- Установил утилиту **traceroute** командой от имени администратора `sudo` `apt install traceroute` на все машины.

> Установка **traceroute**:
>
> ![Установка traceroute](screen%2Fscreen_5_43.png)
>

- Выполнил команду от имени администратора `sudo` `tcpdump -tnv -i enp0s8` на **r1**.

> Вывод команды `sudo tcpdump -tnv -i enp0s8` (r1):
>
> ![Вывод команды sudo tcpdump -tnv -i enp0s8 r1](screen%2Fscreen_5_44.png)
>

<details><summary>Флаги команды</summary>

-
  - Флаг `-t`: убирает временные метки (timestamps) из вывода.
  - Флаг `-n`: отключает преобразование IP-адресов в доменные имена.
  - Флаг `-v`: включает "verbose" режим, предоставляя более подробную информацию о каждом пакете.
  - Флаг `-i`: указывает, на каком сетевом интерфейсе захватывать трафик. Вместо <interface> нужно подставить имя интерфейса, например, `enp0s8`.
</details>

- Выполнил команду `traceroute 10.20.0.10` на **ws11**.

> Вывод команды `traceroute 10.20.0.10` (ws11):
>
> ![Вывод команды traceroute 10.20.0.10 ws11](screen%2Fscreen_5_45.png)
>

- Принцип работы **traceroute**:

*Утилита traceroute отправляет пакеты с постепенно увеличивающимся значением поля TTL (Time-To-Live) в заголовке IP. TTL определяет количество "хопов" (то есть маршрутизаторов), через которые пакет может пройти, прежде чем будет отброшен.*

*Первый пакет отправляется с TTL = 1, второй с TTL = 2 и так далее. Пакет с TTL = 1 доходит только до первого маршрутизатора на пути, где его TTL уменьшается до 0, и маршрутизатор отбрасывает пакет.*

*Когда маршрутизатор отбрасывает пакет из-за истекшего TTL, он отправляет обратно ICMP сообщение "Time Exceeded" к источнику (машине, которая запустила traceroute).*

*Утилита traceroute отправляет UDP-пакеты с возрастающим значением TTL к целевому адресу, но эти пакеты направляются на порты, которые, как правило, не используются на целевом хосте. В большинстве случаев это порты с номерами, начиная от 33434 и выше.*

*Если на целевом хосте нет процесса, который "слушает" на этом порту, хост отвечает сообщением ICMP "Destination Unreachable" с кодом "Port Unreachable". Это означает, что пакет достиг цели, но целевой порт недоступен для приема данных.*

> Вывод команды `sudo tcpdump -tnv -i enp0s8` на r1, после запуска **traceroute** на ws11:
>
> ![Вывод команды sudo tcpdump -tnv -i enp0s8 r1](screen%2Fscreen_5_46.png)
>

*Traceroute продолжает отправлять пакеты с возрастающим TTL, пока не достигнет конечного узла. Когда пакет достигает целевого хоста, traceroute получает от него либо ICMP "Echo Reply", если использовался ICMP, либо сообщение о достижении цели, если использовался UDP.*

*Утилита traceroute использует эти сообщения, чтобы узнать, через какие маршрутизаторы проходит путь до конечного адресата.*


**5.6. Использование протокола ICMP при маршрутизации:**
- Выполнил команду `ping -c 1 10.30.0.111` на **ws11**, указав отправку 1 пакета.

> Вывод команды `ping -c 1 10.30.0.111` (ws11):
>
> ![Вывод команды ping -c 1 10.30.0.111 ws11](screen%2Fscreen_5_47.png)
>

- Выполнил команду от имени администратора `sudo` `tcpdump -tnv -i enp0s8` на **r1**.

> Вывод команды `sudo tcpdump -tnv -i enp0s8` (r1):
>
> ![Вывод команды sudo tcpdump -tnv -i enp0s8 r1](screen%2Fscreen_5_48.png)
>

*Протокол ICMP (Internet Control Message Protocol) — это сетевой протокол, который используется для передачи сообщений об ошибках и управляющих сообщений в IP-сетях. Он является частью набора протоколов семейства IP и работает на сетевом уровне модели OSI.*

- Сохранил дампы образов виртуальных машин в настройках **Virtual Box**, по аналогии с [заданием 4](#4-сетевой-экран).

> Сохранение дампа образа виртуальной машины в VB ws11:
>
> ![Сохранение дампа образа виртуальной машины в VB ws11](screen%2Fscreen_5_49.png)
>

> Сохранение дампа образа виртуальной машины в VB ws21:
>
> ![Сохранение дампа образа виртуальной машины в VB ws21](screen%2Fscreen_5_50.png)
>

> Сохранение дампа образа виртуальной машины в VB ws22:
>
> ![Сохранение дампа образа виртуальной машины в VB ws22](screen%2Fscreen_5_51.png)
>

> Сохранение дампа образа виртуальной машины в VB r1:
>
> ![Сохранение дампа образа виртуальной машины в VB r1](screen%2Fscreen_5_52.png)
>

> Сохранение дампа образа виртуальной машины в VB r2:
>
> ![Сохранение дампа образа виртуальной машины в VB r2](screen%2Fscreen_5_53.png)
>

----------------------------------------------------------------------------

## 6. Динамическая настройка IP с помощью DHCP:
- Проверил ip адрес интерфейса у машины **ws22** командой `ip addr`.

> ip адрес интерфейса `enp0s8` (ws22):
>
> ![ip адрес интерфейса enp0s8 ws22](screen%2Fscreen_6_01.png)
>
> Статический ip 10.20.0.20/26, который мы указали в файле конфигураций **netplan**.
>

**Настройка dhcp сервера**:
- На роутере **r2** установил утилиту `isc-dhcp-server`, командой от имени администратора `sudo` `apt install isc-dhcp-server`.

> Установка **isc-dhcp-server** (r2):
>
> ![Установка isc-dhcp-server r2](screen%2Fscreen_6_02.png)
>

- Открыл файл `/etc/default/isc-dhcp-server` на роутере **r2**.

*Файл `/etc/default/isc-dhcp-server` используется для настройки параметров запуска службы DHCP. В этом файле можно задать сетевые интерфейсы, на которых будет работать DHCP-сервер.*

> Файл `/etc/default/isc-dhcp-server` (r2):
>
> ![Файл /etc/default/isc-dhcp-server r2](screen%2Fscreen_6_03.png)
>

- Т.к. мы будем выдавать динамический ip в сети **10.20.0.0**, укажем интерфейс на котором будет работать **DHCP-сервер** - `enp0s9`, потому что он находится в данной сети с ip **10.20.0.1/26**.

> Вывод команды `ip addr` (r2):
>
> ![Вывод команды ip addr r2](screen%2Fscreen_6_04.png)
>

> Отредактированный файл `/etc/default/isc-dhcp-server` (r2):
>
> ![Отредактированный файл /etc/default/isc-dhcp-server r2](screen%2Fscreen_6_05.png)
>

```bash
INTERFACESv4="enp0s9" # DHCP-сервер будет обслуживать запросы DHCPv4 только на интерфейсе enp0s9.
INTERFACESv6="" # для DHCPv6 сервер не будет активен
```

- Открыл файл `/etc/dhcp/dhcpd.conf` на роутере **r2**.

*Файл `/etc/dhcp/dhcpd.conf` - используется, как конфигурация для **DHCP-сервера (ISC DHCP)**. В этом файле задаются параметры, по которым сервер **DHCP** будет выдавать IP-адреса и другие сетевые настройки клиентам в локальной сети.*

- Добавил новые параметры.

> Отредактированный файл `/etc/dhcp/dhcpd.conf` (r2):
>
> ![Отредактированный файл /etc/dhcp/dhcpd.conf r2](screen%2Fscreen_6_06.png)
>
> `default-lease-time 6000;` - Это значение задает время аренды IP-адреса по умолчанию, которое сервер будет предоставлять клиентам, если клиент не запросил конкретное время аренды. Время указывается в секундах. В данном случае — 6000 секунд (или 100 минут).
> 
> `max-lease-time 7200;` - Это максимальное время аренды IP-адреса, которое может быть предоставлено сервером. Если клиент запрашивает время аренды, превышающее это значение, сервер выдаст аренду на 7200 секунд (или 2 часа).
> 
> `ddns-update-style none;` - Этот параметр отключает динамическое обновление DNS-сервера при аренде адресов (Dynamic DNS updates). Сервер DHCP не будет пытаться обновлять записи на DNS-сервере.
> 

- Указал адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.

> Отредактированный файл `/etc/dhcp/dhcpd.conf` (r2):
>
> ![Отредактированный файл /etc/dhcp/dhcpd.conf r2](screen%2Fscreen_6_07.png)
>

```bash
subnet 10.100.0.0 netmask 255.255.0.0 {} # блок определяющий подсеть 10.100.0.0/16

subnet 10.20.0.0 netmask 255.255.255.192 # блок описывает другую подсеть 10.20.0.0/26
{
    range 10.20.0.36 10.20.0.50; #  диапазон IP-адресов, которые DHCP-сервер может выдавать клиентам в этой подсети. В данном случае от 10.20.0.36 до 10.20.0.50.
    option routers 10.20.0.1; #  IP-адрес шлюза по умолчанию, который будет использоваться клиентами в этой подсети. Клиенты будут использовать 10.20.0.1 как основной шлюз для выхода в другие сети.
    option domain-name-servers 10.20.0.1; # IP-адрес DNS-сервера, который будут использовать клиенты. В данном случае, DNS-сервер совпадает с адресом шлюза 10.20.0.1.
}
```

- Открыл файл `/etc/resolv.conf` на роутере **r2**.
- Добавил строку `nameserver 8.8.8.8`

> Отредактированный файл `/etc/resolv.conf` (r2):
>
> ![Отредактированный файл /etc/resolv.conf r2](screen%2Fscreen_6_08.png)
>

* `nameserver 8.8.8.8` - эта строка добавляет дополнительный **DNS-сервер**, к которому система может обратиться для разрешения доменных имен. В данном случае, это **8.8.8.8** — **публичный DNS-сервер**, предоставляемый компанией **[Google](https://google.com)**. 

- Выполнил команду от имени администратора `sudo` `systemctl restart isc-dhcp-server`, что бы перезапустить систему **DHCP-сервера** на **r2**.
- Выполнил команду от имени администратора `sudo` `systemctl status isc-dhcp-server`, что бы проверить статус работы системы на **r2**.


> Успешно запущенная система **DHCP-сервера** (r2):
>
> ![Успешно запущенная система DHCP-сервераf r2](screen%2Fscreen_6_09.png)
>

- Для получения ip адреса для нашей машины **ws22**, с помощью **DHCP-сервера** на роутере **r2**, настроить файл конфигурации netplan.
- Изменил файл `/etc/netplan/00-installer-config.yaml`.

> Отредактированный файл `/etc/netplan/00-installer-config.yaml` (ws22):
>
> ![Отредактированный файл /etc/netplan/00-installer-config.yaml ws22](screen%2Fscreen_6_10.png)
> 
> Включил динамическое получение ip адреса через **dhcp (`true`)**, и закомментировал строки со статическим заданным ip.
> 

- Применил настройки на **ws22**, командой от имени администратора `sudo` `netplan apply`.
- Проверил получение нового ip от нашего **DHCP-сервера**, командой `ip a`.

> Новый ip адрес (ws22):
>
> ![Новый ip адрес ws22](screen%2Fscreen_6_11.png)
>
> `10.20.0.36/26` - полученный ip от нашего **DHCP-сервера**, из диапазона (range): `10.20.0.36` - `10.20.0.50`.
>

- Перезапустил машину **ws22**, командой от имени администратора `sudo` `reboot`.
- Выполнил команду `ip a`, что бы проверить настройки после перезапуска.

> Вывод команды `ip a` (ws22):
>
> ![Вывод команды ip a ws22](screen%2Fscreen_6_12.png)
>

- Пропинговал **ws22** с **ws21**, командой `ping -c 5 10.20.0.36`, указав отправку 5 пакетов.

> Успешно пропингованный ip 10.20.0.36:
>
> ![Успешно пропингованный ip 10.20.0.36](screen%2Fscreen_6_13.png)
>

- Проверил ip адрес интерфейса у машины **ws11** командой `ip a`.

> ip адрес интерфейса `enp0s8` (ws11):
>
> ![ip адрес интерфейса enp0s8 ws11](screen%2Fscreen_6_14.png)
>
> Статический ip 10.10.0.2/18, который мы указали в файле конфигураций **netplan**.
>

- Настроил файл конфигурации `/etc/netplan/00-installer-config.yaml` на **ws11**.

> Отредактированный файл `/etc/netplan/00-installer-config.yaml` (ws11):
>
> ![Отредактированный файл /etc/netplan/00-installer-config.yaml ws11](screen%2Fscreen_6_15.png)
>
> Указал для интерфейса **enp0s8** MAC-адрес: `10:10:10:10:10:BA`, включил динамическое получение ip адреса через **dhcp (`true`)**, и закомментировал строки со статическим заданным ip.
>

- Открыл интерфейс **Virtual Box**.
- Зашел в настройки сети машины **ws11**, и указал MAC-адрес: `10:10:10:10:10:BA` для интерфейса с внутренней сетью.

> Указание нового MAC-адреса в VB **ws11**:
>
> ![Указание нового MAC-адреса в VB ws11](screen%2Fscreen_6_16.png)
>

- Установил утилиту `isc-dhcp-server` на **r1**.
- Добавил в файл `/etc/resolv.conf` строку - `nameserver 8.8.8.8`, по аналогии с **r2**.

> Отредактированный файл `/etc/resolv.conf` (r1):
>
> ![Отредактированный файл /etc/resolv.conf r1](screen%2Fscreen_6_17.png)
>

- Указал в `/etc/default/isc-dhcp-server` на **r1**, интерфейс на котором будет работать **DHCP-сервер**.

> Отредактированный файл `/etc/default/isc-dhcp-server` (r1):
>
> ![Отредактированный файл /etc/default/isc-dhcp-server r2](screen%2Fscreen_6_18.png)
>

```bash
INTERFACESv4="enp0s8" # DHCP-сервер будет обслуживать запросы DHCPv4 только на интерфейсе enp0s8.
INTERFACESv6="" # для DHCPv6 сервер не будет активен
```

- Отредактировал файл `/etc/dhcp/dhcpd.conf` на роутере **r1**, по аналогии с **r2**, но сделал выдачу адресов с жесткой привязкой к MAC-адресу (ws11).

> Отредактированный файл `/etc/dhcp/dhcpd.conf` (r1):
>
> ![Отредактированный файл /etc/dhcp/dhcpd.conf r2](screen%2Fscreen_6_19.png)
>
> ![Отредактированный файл /etc/dhcp/dhcpd.conf r2](screen%2Fscreen_6_20.png)
>

```bash
subnet 10.100.0.0 netmask 255.255.0.0 {} # блок определяющий подсеть 10.100.0.0/16

subnet 10.10.0.0 netmask 255.255.192.0 # блок описывает другую подсеть 10.10.0.0/18
{
    range 10.10.0.2 10.10.0.50; #  диапазон IP-адресов, которые DHCP-сервер может выдавать клиентам в этой подсети. В данном случае от 10.10.0.2 до 10.10.0.50.
    option routers 10.10.0.1; #  IP-адрес шлюза по умолчанию, который будет использоваться клиентами в этой подсети. Клиенты будут использовать 10.10.0.1 как основной шлюз для выхода в другие сети.
    option domain-name-servers 10.10.0.1; # IP-адрес DNS-сервера, который будут использовать клиенты. В данном случае, DNS-сервер совпадает с адресом шлюза 10.10.0.1.
    
    host ws11 # блок, описывающий параметры для устройства с именем ws11. Этот блок задает статический IP-адрес для устройства на основе его MAC-адреса.
         {
         hardware ethernet 10:10:10:10:10:BA; #  MAC-адрес устройства ws11. Этот адрес используется для идентификации устройства при выдаче IP-адреса.
         fixed-address 10.10.0.45; # статический IP-адрес 10.10.0.45, который будет всегда назначаться устройству ws11, когда оно подключается к этой подсети через DHCP-сервер.
         option domain-name-servers 10.10.0.1; # IP-адрес DNS-сервера, который будет использовать ws11. Здесь используется тот же DNS-сервер, что и для всей подсети.
         }
}
```

- Выполнил команду от имени администратора `sudo` `systemctl restart isc-dhcp-server`, что бы перезапустить систему **DHCP-сервера** на **r1**.
- Выполнил команду от имени администратора `sudo` `systemctl status isc-dhcp-server`, что бы проверить статус работы системы на **r1**.

> Успешно запущенная система **DHCP-сервера** (r1):
>
> ![Успешно запущенная система DHCP-сервера r1](screen%2Fscreen_6_21.png)
>

- Перезапустил систему **netplan** командой от имени администратора `sudo` `natplan apply` на **ws11**, чтобы обновить ip адрес интерфейса.
- Выполнил команду `ip a`, что бы проверить успешное получение нового ip.

> Новый ip полученный по MAC-адресу (ws11):
>
> ![Новый ip полученный по MAC-адресу ws11](screen%2Fscreen_6_22.png)
>

- Пропинговал **ws22** с **ws11**, командой `ping -c 3 10.20.0.36`, указав отправку 3 пакетов.

> Успешно пропингованный ip 10.20.0.36:
>
> ![Успешно пропингованный ip 10.20.0.36](screen%2Fscreen_6_23.png)
>

- Проверил ip адрес интерфейса у машины **ws21** командой `ip a`.

> ip адрес интерфейса `enp0s8` (ws21):
>
> ![ip адрес интерфейса enp0s8 ws21](screen%2Fscreen_6_24.png)
>
> Статический ip 10.20.0.10/26, который мы указали в файле конфигураций **netplan**.
>

- Выполнил команду от имени администратора `sudo` `dhclient -r` на **ws21**.
- Выполнил команду от имени администратора `sudo` `dhclient` на **ws21**.

*Команда `dhclient` используется для управления DHCP-клиентом на Linux-системах.*

<details><summary>Разбор команд:</summary>

-
  - Команда `sudo dhclient` с флагом `-r`: Эта команда освобождает (отменяет) текущий IP-адрес, полученный через **DHCP**. Флаг `-r` говорит DHCP-клиенту "отказаться" от IP-адреса, который был выдан ему DHCP-сервером. При этом DHCP-клиент отправляет на сервер сообщение о том, что он больше не использует данный IP-адрес.
  - Команда `sudo dhclient`: Когда вы запускаете команду **dhclient**, система отправляет запрос **DHCP Discover** для поиска DHCP-сервера в сети. Затем сервер выдает IP-адрес и другие сетевые параметры (например, шлюз и DNS-серверы), которые система применяет.

</details>


- Проверил получение нового ip от нашего **DHCP-сервера**, командой `ip a`.

> Новый ip адрес (ws21):
>
> ![Новый ip адрес ws21](screen%2Fscreen_6_25.png)
>
> `10.20.0.38/26` - полученный ip от нашего **DHCP-сервера**, из диапазона (range): `10.20.0.36` - `10.20.0.50`.
>

- Сохранил дампы образов виртуальных машин в настройках **Virtual Box**, по аналогии с [заданием 4](#4-сетевой-экран) и [заданием 5](#5-статическая-маршрутизация-сети).

> Сохранение дампа образа виртуальной машины в VB ws11:
>
> ![Сохранение дампа образа виртуальной машины в VB ws11](screen%2Fscreen_6_26.png)
>

> Сохранение дампа образа виртуальной машины в VB ws21:
>
> ![Сохранение дампа образа виртуальной машины в VB ws21](screen%2Fscreen_6_27.png)
>

> Сохранение дампа образа виртуальной машины в VB ws22:
>
> ![Сохранение дампа образа виртуальной машины в VB ws22](screen%2Fscreen_6_28.png)
>

> Сохранение дампа образа виртуальной машины в VB r1:
>
> ![Сохранение дампа образа виртуальной машины в VB r1](screen%2Fscreen_6_29.png)
>

> Сохранение дампа образа виртуальной машины в VB r2:
>
> ![Сохранение дампа образа виртуальной машины в VB r2](screen%2Fscreen_6_30.png)
>

----------------------------------------------------------------------------

## 7. NAT:
- Открыл дампы виртуальных машин на состояние завершенного [пятого задания](#5-статическая-маршрутизация-сети).
- Установил утилиту `apache2` на машины **ws22** **r1**, командой от имени администратора `sudo` `apt install apache2`.

> Установка утилиты `apache2`:
>
> ![Установка утилиты apache2](screen%2Fscreen_7_01.png)
>

- В файле `/etc/apache2/ports.conf` на **ws22** и **r1** изменил строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделал сервер Apache2 общедоступным.

> Файл `/etc/apache2/ports.conf` до изменения (ws22):
>
> ![Установка утилиты apache2](screen%2Fscreen_7_02.png)
>

> Файл `/etc/apache2/ports.conf` после изменений (ws22):
>
> ![Установка утилиты apache2](screen%2Fscreen_7_03.png)
>

> Файл `/etc/apache2/ports.conf` после изменений (r1):
>
> ![Установка утилиты apache2](screen%2Fscreen_7_04.png)
>

- Запустил веб-сервер Apache командой от имени администратора `sudo` `service apache2 start` на **ws22**.
- Проверил статус сервера командой от имени администратора `sudo` `service apache2 status` на **ws22**.


> Успешный запуск сервера `Apache` (ws22):
>
> ![Успешный запуск сервера Apache ws22](screen%2Fscreen_7_05.png)
>

- Запустил веб-сервер Apache командой от имени администратора `sudo` `service apache2 start` на **r1**.
- Проверил статус сервера командой от имени администратора `sudo` `service apache2 status` на **r1**.


> Успешный запуск сервера `Apache` (r1):
>
> ![Успешный запуск сервера Apache r1](screen%2Fscreen_7_06.png)
>

- Добавил в фаервол, созданный по аналогии с фаерволом из [Части 4](#4-сетевой-экран), на **r2** следующие правила:

> Созданый срипт-файл `/etc/firewall.sh` на **r2**:
>
> ![Созданый срипт-файл /etc/firewall.sh на r2](screen%2Fscreen_7_07.png)
>

```bash
#!/bin/sh

# очистка всех правил в таблице «filter» (по умолчанию).
iptables -F  # очистка всех правил в таблице "filter".
iptables -X  # удаление всех нестандартных цепочек в таблице "filter".

# очистка всех правил в таблице «nat» (таблица для Network Address Translation).
iptables -F -t nat  # очистка всех правил в таблице "nat".

# установка политики по умолчанию для цепочки FORWARD (маршрутизация) — сброс всех пакетов.
iptables --policy FORWARD DROP  # устанавливает политику по умолчанию для цепочки "FORWARD", которая будет отбрасывать все маршрутизируемые пакеты.
```

- Разрешил доступ и запустил файл на **r2** командами от имени администратора `sudo` `chmod +x /etc/firewall.sh` и `sudo` `/etc/firewall.sh`.

> Применение команд `sudo` `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` (r2):
>
> ![Вывод команд chmod +x /etc/firewall.sh и /etc/firewall.sh r2](screen%2Fscreen_7_08.png)
>

- Выполнил команду от имени администратора `sudo` `iptables -L --line-number`, что бы проверить список действующих правил фаервола.

> Вывод команды `sudo` `iptables -L --line-number` (r2):
>
> ![Вывод команды sudo iptables -L --line-number r2](screen%2Fscreen_7_09.png)
>

- Попытался пропинговать **ws22** c **r1**, с указанием 3 пакетов, командой `ping -с 3 10.20.0.20`.

> Пинг `ip 10.20.0.20` ws22 без ответа (r1):
>
> ![Пинг ws22 без ответа ip 10.20.0.20 r1](screen%2Fscreen_7_10.png)
>

- Добавил новые правила в файл `/etc/firewall.sh` на **r2**, что бы разрешить маршрутизацию всех пакетов протокола ICMP.

> Измененный файл `/etc/firewall.sh` (r2):
>
> ![Измененный файл /etc/firewall.sh r2](screen%2Fscreen_7_11.png)
>

```bash
#!/bin/sh

# очистка всех правил в таблице «filter» (по умолчанию).
iptables -F  # очистка всех правил в таблице "filter".
iptables -X  # удаление всех нестандартных цепочек в таблице "filter".

# очистка всех правил в таблице «nat» (таблица для Network Address Translation).
iptables -F -t nat  # очистка всех правил в таблице "nat".

# установка политики по умолчанию для цепочки FORWARD (маршрутизация) — сброс всех пакетов.
iptables --policy FORWARD DROP  # устанавливает политику по умолчанию для цепочки "FORWARD", которая будет отбрасывать все маршрутизируемые пакеты.

# разрешение прохождения всех ICMP-пакетов (например, ping) через маршрутизатор.
iptables -A FORWARD -p icmp -j ACCEPT  # добавляет правило, позволяющее ICMP-пакетам проходить через маршрутизатор.
```

- Разрешил доступ и запустил файл на **r2** командами от имени администратора `sudo` `chmod +x /etc/firewall.sh` и `sudo` `/etc/firewall.sh`.

> Применение команд `sudo` `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` (r2):
>
> ![Применение команд sudo chmod +x /etc/firewall.sh и /etc/firewall.sh r2](screen%2Fscreen_7_12.png)
>

- Выполнил команду от имени администратора `sudo` `iptables -L --line-number`, что бы проверить список действующих правил фаервола.

> Вывод команды `sudo` `iptables -L --line-number` (r2):
>
> ![Вывод команды sudo iptables -L --line-number r2](screen%2Fscreen_7_13.png)
>

- Пропинговал **ws22** c **r1**, с указанием 3 пакетов, командой `ping -с 3 10.20.0.20`.

> Успешно пропингованный `ip 10.20.0.20` (r1):
>
> ![Успешно пропингованный ip 10.20.0.20 r1](screen%2Fscreen_7_14.png)
>

- Добавил новые правила в файл `/etc/firewall.sh` на **r2**:
  - Включил **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за **r2** (по обозначениям из [Части 5](#5-статическая-маршрутизация-сети) - сеть `10.20.0.0`).
  - Включил **DNAT** на **8080** порт машины **r2**.
  - Добавил к веб-серверу **Apache**, запущенному на **ws22**, доступ извне сети.
  - Разрешил tcp-соединение, предназначенное **ws22** и **80 порту**.

> Измененный файл `/etc/firewall.sh` (r2):
>
> ![Измененный файл /etc/firewall.sh (r2)](screen%2Fscreen_7_15.png)
>

```bash
#!/bin/sh

# очистка всех правил в таблице «filter» (по умолчанию).
iptables -F  # очистка всех правил в таблице "filter".
iptables -X  # удаление всех нестандартных цепочек в таблице "filter".

# очистка всех правил в таблице «nat» (таблица для Network Address Translation).
iptables -F -t nat  # очистка всех правил в таблице "nat".

# установка политики по умолчанию для цепочки FORWARD (маршрутизация) — сброс всех пакетов.
iptables --policy FORWARD DROP  # устанавливает политику по умолчанию для цепочки "FORWARD", которая будет отбрасывать все маршрутизируемые пакеты.

# разрешение прохождения всех ICMP-пакетов (например, ping) через маршрутизатор.
iptables -A FORWARD -p icmp -j ACCEPT  # добавляет правило, позволяющее ICMP-пакетам проходить через маршрутизатор.

# разрешение прохождения всех TCP-пакетов через маршрутизатор.
iptables -A FORWARD -p tcp -j ACCEPT  # добавляет правило, позволяющее TCP-пакетам проходить через маршрутизатор.

# настройка SNAT для маскировки исходящих пакетов, заменяя их исходный IP на 10.100.0.12.
iptables -t nat -A POSTROUTING -o enp0s8 -s 10.20.0.0/16 -j SNAT --to-source 10.100.0.12

# настройка DNAT для перенаправления входящих пакетов на порт 8080 к внутреннему серверу на 10.20.0.20:80.
iptables -t nat -A PREROUTING -p tcp -d 10.20.0.1 --dport 8080 -j DNAT --to-destination 10.20.0.20:80
```

- Отключил сетевой интерфейс NAT на **r2** в **VirtualBox**.

> Отключение сетевого интерфейса enp0s3 в **VBx** (r2):
>
> ![Отключение сетевого интерфейса enp0s3 в VBx r2](screen%2Fscreen_7_16.png)
>

- Отключил настройки `dhcp` интерфейса `enp0s3` в файле `/etc/netplan/00-installer-config.yam` на **r2**.

> Измененный файл `/etc/netplan/00-installer-config.yam` (r2):
>
> ![Измененный файл /etc/netplan/00-installer-config.yam r2](screen%2Fscreen_7_17.png)
>

- Применил настройки `netplan`, командой от имени администратора `sudo` `netplan apply` на **r2**.
- Проверил отключение интерфейса `enp0s3`, командой `ip a` на **r2**.

> Список активных сетевых интерфейсов (r2):
>
> ![Список активных сетевых интерфейсов r2](screen%2Fscreen_7_18.png)
>

- Разрешил доступ и запустил файл фаервола на **r2** командами от имени администратора `sudo` `chmod +x /etc/firewall.sh` и `sudo` `/etc/firewall.sh`.

> Применение команд `sudo` `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` (r2):
>
> ![Применение команд sudo chmod +x /etc/firewall.sh и /etc/firewall.sh r2](screen%2Fscreen_7_19.png)
>

- Выполнил команду от имени администратора `sudo` `iptables -L --line-number`, что бы проверить список действующих правил фаервола.

> Вывод команды `sudo` `iptables -L --line-number` (r2):
>
> ![Вывод команды sudo iptables -L --line-number r2](screen%2Fscreen_7_20.png)
>

- Проверил соединение по **TCP** для **SNAT**: для этого с **ws22** подключиться к серверу **Apache** на **r1** командой `telnet 10.10.0.1 80`.

> Вывод команды `telnet 10.10.0.1 80` (ws22):
>
> ![Вывод команды telnet 10.10.0.1 80 ws22](screen%2Fscreen_7_21.png)
>

- Проверил соединение по **TCP** для **DNAT**: для этого с **r1** подключиться к серверу **Apache** на **ws22** командой `telnet 10.20.0.1 8080`, обращался по адресу **r2** и порту **8080**.

> Вывод команды `telnet 10.20.0.1 8080` (r1):
>
> ![Вывод команды telnet 10.20.0.1 8080 r1](screen%2Fscreen_7_22.png)
>

- Сохранил дампы образов виртуальных машин в настройках **Virtual Box**, по аналогии с [заданием 4](#4-сетевой-экран), [заданием 5](#5) и [заданием 6](#6-динамическая-настройка-ip-с-помощью-dhcp).

> Сохранение дампа образа виртуальной машины в VB ws11:
>
> ![Сохранение дампа образа виртуальной машины в VB ws11](screen%2Fscreen_7_23.png)
>

> Сохранение дампа образа виртуальной машины в VB ws21:
>
> ![Сохранение дампа образа виртуальной машины в VB ws21](screen%2Fscreen_7_24.png)
>

> Сохранение дампа образа виртуальной машины в VB ws22:
>
> ![Сохранение дампа образа виртуальной машины в VB ws22](screen%2Fscreen_7_25.png)
>

> Сохранение дампа образа виртуальной машины в VB r1:
>
> ![Сохранение дампа образа виртуальной машины в VB r1](screen%2Fscreen_7_26.png)
>

> Сохранение дампа образа виртуальной машины в VB r2:
>
> ![Сохранение дампа образа виртуальной машины в VB r2](screen%2Fscreen_7_27.png)
>

----------------------------------------------------------------------------

## 8. Знакомство с SSH Tunnels:
- Открыл дампы виртуальных машин на состояние завершенного [Части 5](#5-статическая-маршрутизация-сети).
- Виртуальную машину **r2** открыл на состояние завершенного [Части 7](#7-nat).

- Проверил настройки фаервола на **r2**, командами `cat /etc/firewall.sh` и `sudo` `iptables -L --line-number`.

> Действующие правила `iptables` (r2):
>
> ![Действующие правила iptables r2](screen%2Fscreen_8_01.png)
>

- Установил утилиту `apache2` на **ws22**.
- В файле `/etc/apache2/ports.conf` на **ws22** изменил строку `Listen 80` на `Listen localhost:80`.

*Это нужно чтобы `Apache` слушал только на localhost (127.0.0.1).*

> Измененный файл `/etc/apache2/ports.conf` (ws22):
>
> ![Измененный файл /etc/apache2/ports.conf ws22](screen%2Fscreen_8_02.png)
>

- Перезапустил сервис `apache2`, командой от имени администратора `sudo` `service apache2 restart`.
- Проверил работу сервиса, командой от имени администратора `sudo` `service apache2 status`.

> Успешный запуск `apache2` (ws22):
>
> ![Успешный запуск apache2 ws22](screen%2Fscreen_8_03.png)
>

- Установил сервис `ssh` на **ws22**
- Проверил статус сервиса `ssh`, командой от имени администратора `sudo` `service ssh status`.

> Успешный запуск `ssh` (ws22):
>
> ![Успешный запуск ssh ws22](screen%2Fscreen_8_04.png)
>

**Настройка Local TCP Forwarding с ws21 до ws22:**

*Local TCP Forwarding позволяет перенаправить локальный порт на ws21 к порту на ws22 через SSH-туннель.*

- Выполнил команду на **ws21** `ssh -L 8080:localhost:80 user@10.20.0.20`.

*`8080` — это порт на ws21, через который мы будем получать доступ к Apache на ws22.*

> Успешное подключение по ssh с ws21 к ws22:
>
> ![Успешное подключение по ssh с ws21 к ws22](screen%2Fscreen_8_05.png)
>

- Переключился на второе окно терминала сочетанием клавиш `alt` + `F2`.
- Для проверки подключения, в терминале **ws21** ввел команду `telnet 127.0.0.1 8080`.

> Вывод команды `telnet 127.0.0.1 8080` (ws21):
>
> ![Вывод команды telnet 127.0.0.1 8080 ws21](screen%2Fscreen_8_06.png)
>

- Выполнил команду на **ws11** `ssh -R 9090:localhost:80 user@10.20.0.20`.

*`9090` — это порт на ws11, через который мы будем получать доступ к Apache на ws22.*

> Успешное подключение по ssh с ws11 к ws22:
>
> ![Успешное подключение по ssh с ws11 к ws22](screen%2Fscreen_8_07.png)
>

- Переключился на второе окно терминала сочетанием клавиш `alt` + `F2`.
- Для проверки подключения, в терминале **ws11** ввел команду `telnet 127.0.0.1 9090`.

> Вывод команды `telnet 127.0.0.1 9090` (ws11):
>
> ![Вывод команды telnet 127.0.0.1 8080 ws11](screen%2Fscreen_8_08.png)
>

- Разбор команд:
  - `ssh -L [local_port]:[remote_host]:[remote_port] [user]@[ssh_server]`:
    - Флаг `-L`: используется для создания локального перенаправления (**Local TCP forwarding**). 
    - `[local_port]` — локальный порт на нашей машине (**ws21**), который будет прослушиваться.
    - `[remote_host]` — целевой удаленный хост (например, **localhost** на **ws22**), к которому должен подключаться туннель.
    - `[remote_port]` — порт удаленного хоста, к которому туннель будет подключаться.
    - `[ssh_server]` — **SSH-сервер (ws22)**, через который будет установлен туннель.


***Local forwarding** (`-L`) позволяет вам перенаправить порт на вашей локальной машине (**ws21**) через **SSH-соединение**, чтобы достучаться до удаленного порта на другой машине (**ws22**).*

*Мы подключились по **SSH** к **ws22**, и любой запрос к localhost:8080 на нашей локальной машине (ws21) будет отправляться на порт 80 на **localhos**t на **ws22**.  Команда `telnet 127.0.0.1 8080` на **ws2**1 работает, потому что `localhost:8080` на **ws21** перенаправляется на `localhost:80` на **ws22**.*

-
  - `ssh -R [remote_port]:[local_host]:[local_port] [user]@[ssh_server]`:
    - Флаг `-R`: используется для создания удаленного перенаправления (**Remote TCP forwarding**).
    - `[remote_port]` — порт на удаленном **SSH-сервере** (**ws22**), который будет прослушиваться.
    - `[local_host]` — локальный хост (например, **localhost** на **ws11**), к которому должен подключаться туннель.
    - `[local_port]` — порт на локальном хосте, к которому туннель будет подключаться.
    - `[ssh_server]` — **SSH-сервер**, через который устанавливается туннель (**ws22**).

***Remote forwarding** (`-R`) позволяет перенаправить порт на удаленной машине (**ws22**) на локальный порт на вашей машине (**ws11**).*

*Это создаст **SSH-туннель**, который заставит **ws22** прослушивать порт `8080`. Любой трафик, идущий на `ws22:8080`, будет перенаправлен на `localhost:80` на вашей локальной машине (**ws11**).*

***Local forwarding** (`-L`) на `ws11` будет правильным подходом, если мы хотим подключиться к веб-серверу на `ws22`, используя локальный порт на `ws21`. Если с флагом `-L` все работает, это означает, что туннель настроен правильно для этой цели.*

***Remote forwarding** (`-R`) при подключении к `ws22`, нужно использовать, если мы хотим перенаправить порт с `ws11` (или другого клиента) на `ws22`, но в нашем сценарии мы используем его наоборот, что неправильно.*

*В нашем случае, использование `-L` на `ws21` для туннелирования доступа к веб-серверу на `ws22` — правильный подход.*

*Если мы подключаемся с использованием `-R` и у нас возникает ошибка `connection refused` при попытке использовать `telnet`, это потому, что `-R` перенаправляет порт на удаленной машине (`ws22`), а не на локальной (`ws11`). Следовательно, в нашем сценарии `-R` не дает нужного результата.*

**Заключение: нужно использовать флаг `-L` для локального перенаправления с `ws11`, чтобы получить доступ к веб-серверу на `ws22`, и именно поэтому `telnet` работает с использованием `-L`.**

- Сохранил дампы образов виртуальных машин в настройках **Virtual Box**, по аналогии с [заданием 4](#4-сетевой-экран), [заданием 5](#5), [заданием 6](#6-динамическая-настройка-ip-с-помощью-dhcp) и [заданием 7](#7-nat).

> Сохранение дампа образа виртуальной машины в VB ws11:
>
> ![Сохранение дампа образа виртуальной машины в VB ws11](screen%2Fscreen_8_09.png)
>

> Сохранение дампа образа виртуальной машины в VB ws21:
>
> ![Сохранение дампа образа виртуальной машины в VB ws21](screen%2Fscreen_8_10.png)
>

> Сохранение дампа образа виртуальной машины в VB ws22:
>
> ![Сохранение дампа образа виртуальной машины в VB ws22](screen%2Fscreen_8_11.png)
>

> Сохранение дампа образа виртуальной машины в VB r1:
>
> ![Сохранение дампа образа виртуальной машины в VB r1](screen%2Fscreen_8_12.png)
>

> Сохранение дампа образа виртуальной машины в VB r2:
>
> ![Сохранение дампа образа виртуальной машины в VB r2](screen%2Fscreen_8_13.png)
>

----------------------------------------------------------------------------
